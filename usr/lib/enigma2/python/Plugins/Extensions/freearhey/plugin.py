# import zlib, base64
# exec (zlib.decompress(base64.b64decode('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')))

import base64
from Components.Label import Label
from Components.Sources.StaticText import StaticText
from Components.MenuList import MenuList
from Components.Pixmap import Pixmap, MovingPixmap
from Components.MultiContent import MultiContentEntryText #, MultiContentEntryPixmap, MultiContentEntryPixmapAlphaTest
from Components.ServiceEventTracker import ServiceEventTracker, InfoBarBase
from enigma import eTimer, gFont, eTimer, eConsoleAppContainer, ePicLoad, loadPNG, getDesktop, eServiceReference, iPlayableService, eListboxPythonMultiContent, RT_HALIGN_LEFT, RT_HALIGN_RIGHT, RT_HALIGN_CENTER, RT_VALIGN_CENTER, eListbox
from Plugins.Plugin import PluginDescriptor
from Screens.Screen import Screen
from Screens.MessageBox import MessageBox
from Screens.InfoBarGenerics import *
from Screens.InfoBar import MoviePlayer, InfoBar
from twisted.web.client import downloadPage, getPage, error
from Tools.Directories import fileExists, resolveFilename, SCOPE_PLUGINS, pathExists
from Tools.LoadPixmap import LoadPixmap
import os, time, socket
import sha
import hashlib
import ssl
import re
from time import strptime, mktime
from Components.ActionMap import *
import sys
from Components.Console import Console as iConsole

try:
        from enigma import eDVBDB
except ImportError:
        eDVBDB = None


BRAND = '/usr/lib/enigma2/python/boxbranding.so'
BRANDP = '/usr/lib/enigma2/python/Plugins/PLi/__init__.pyo'
BRANDPLI ='/usr/lib/enigma2/python/Tools/StbHardware.pyo'
estm3u = 'aHR0cDovL3RpdnVzdHJlYW0uY29tL2ZoLnBocA=='
m3uest = base64.b64decode(estm3u)

PY3 = sys.version_info.major >= 3

if PY3:
    from urllib.request import  Request, urlopen
    from urllib.error import URLError, HTTPError
    from urllib.parse import urlparse
    from urllib.parse import quote, unquote_plus, unquote, urlencode
    import http.cookiejar
    from http.client import HTTPConnection, CannotSendRequest, BadStatusLine, HTTPException
    from urllib.request import urlretrieve

else:
    import cookielib
    from urllib2 import Request, urlopen
    from urllib2 import URLError, HTTPError
    from urlparse import urlparse
    from urllib import quote, unquote_plus, unquote, urlencode
    from httplib import HTTPConnection, CannotSendRequest, BadStatusLine, HTTPException
    from urllib import urlretrieve

headers            = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.100 Safari/537.36',
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' }

cj = {}
# sz_w = getDesktop(0).size().width()
sz_w = getDesktop(0).size()
# if sz_w == 1920:
if sz_w.width() > 1280:
    Height = 60
else:
    Height = 40
# if sz_w.width() > 1280:
def checkStr(txt):
    # convert variable to type str both in Python 2 and 3
    if PY3:
        # Python 3
        if type(txt) == type(bytes()):
            txt = txt.decode('utf-8')
    else:
        #Python 2
        if type(txt) == type(unicode()):
            txt = txt.encode('utf-8')
    return txt
PLUGIN_PATH = '/usr/lib/enigma2/python/Plugins/Extensions/freearhey'

global skin_path
skin_path= PLUGIN_PATH +'/skin'
if fileExists(BRAND)or fileExists(BRANDP):
    skin_path= skin_path + '/skin_pli/'
else:
    skin_path= skin_path + '/skin_cvs/'

from enigma import addFont
try:
    addFont('%s/nxt1.ttf' % PLUGIN_PATH, 'RegularIPTV', 100, 1)
except Exception as ex:
    print('addfont', ex)

def checkInternet():
        try:
                response = urlopen("http://google.com", None, 5)
                response.close()
        except HTTPError:
                return False
        except URLError:
                return False
        except socket.timeout:
                return False

def getUrl(url):
  # if checkInternet():                            
    try:
            req = Request(url)
            req.add_header('User-Agent', 'Mozilla/5.0 (Windows NT 6.1; rv:52.0) Gecko/20100101 Firefox/52.0')
            response = urlopen(req)
            link = response.read()
            response.close()
            print("link =", link)
            return link

    except:
        if PY3:
            e = urllib.error.URLError# as e:
        else:
            e = urllib2.URLError #, e:
        print('We failed to open "%s".' % url)
        if hasattr(e, 'code'):
            print('We failed with error code - %s.' % e.code)
        if hasattr(e, 'reason'):
            print('We failed to reach a server.')
            print('Reason: ', e.reason)
    # else:
            # session.open(MessageBox, "No Internet", MessageBox.TYPE_INFO)
def ReloadBouquet():
    try:
        eDVBDB.getInstance().reloadServicelist()
        eDVBDB.getInstance().reloadBouquets()
    except:
        os.system('wget -qO - http://127.0.0.1/web/servicelistreload?mode=2 > /dev/null 2>&1 &')

def remove_line(filename, what):
    if os.path.isfile(filename):
        file_read = open(filename).readlines()
        file_write = open(filename, 'w')
        for line in file_read:
            if what not in line:
                file_write.write(line)
        file_write.close()

class m2list(MenuList):

    def __init__(self, list):
        MenuList.__init__(self, list, False, eListboxPythonMultiContent)
        self.l.setFont(0, gFont('Regular', 14))
        self.l.setFont(1, gFont('Regular', 16))
        self.l.setFont(2, gFont('Regular', 18))
        self.l.setFont(3, gFont('Regular', 20))
        self.l.setFont(4, gFont('Regular', 22))
        self.l.setFont(5, gFont('Regular', 24))
        self.l.setFont(6, gFont('Regular', 26))
        self.l.setFont(7, gFont('Regular', 28))
        self.l.setFont(8, gFont('Regular', 32))
        self.l.setFont(9, gFont('Regular', 38))

def show_(name, link):#, img, session, description):
    res = [(name,link)]
    # if sz_w == 1920:
    if sz_w.width() > 1280:
        res.append(MultiContentEntryText(pos=(0, 0), size=(800, 40), font=9, text=name, flags=RT_HALIGN_CENTER | RT_VALIGN_CENTER))
    else:
        res.append(MultiContentEntryText(pos=(0, 0), size=(800, 40), font=8, text=name, flags=RT_HALIGN_CENTER | RT_VALIGN_CENTER))
    return res



def cat_(letter, link):
    res = [(letter, link)]
    # if sz_w == 1920:
    if sz_w.width() > 1280:
        res.append(MultiContentEntryText(pos=(0, 0), size=(800, 40), font=9, text=letter, flags=RT_HALIGN_CENTER | RT_VALIGN_CENTER))
    else:
        res.append(MultiContentEntryText(pos=(0, 0), size=(800, 40), font=8, text=letter, flags=RT_HALIGN_CENTER | RT_VALIGN_CENTER))
    return res

class freearhey(Screen):

    def __init__(self, session):
        if sz_w.width() > 1280:
                path = skin_path + 'defaultListScreen_new.xml'
        else:
                path =  skin_path + 'defaultListScreen.xml'
        with open(path, 'r') as f:
            self.skin = f.read()
            f.close()
        self.session = session
        Screen.__init__(self, session)
        self['actions'] = ActionMap(['OkCancelActions',
         'ColorActions',
         'DirectionActions',
         'MovieSelectionActions'], {'up': self.up,
         'down': self.down,
         'left': self.left,
         'right': self.right,
         'ok': self.ok,
		 'green': self.message2,
         'cancel': self.exit,
         'red': self.exit}, -1)
        self['menulist'] = m2list([])
        self['red'] = Label(_('Exit'))
        self['green'] = Label(_('Export'))
        self['title'] = Label('free')
        self['name'] = Label('')
        self['text'] = Label('')
        # self['poster'] = Pixmap()
        self.picload = ePicLoad()
        self.picfile = ''
        self.currentList = 'menulist'
        self.menulist = []
        self.loading_ok = False
        self.count = 0
        self.loading = 0
        self.oldService = self.session.nav.getCurrentlyPlayingServiceReference()
        self.onLayoutFinish.append(self.downmasterpage)

    def up(self):
        self[self.currentList].up()
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        # self.load_poster()

    def down(self):
        self[self.currentList].down()
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        # self.load_poster()

    def left(self):
        self[self.currentList].pageUp()
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        # self.load_poster()

    def right(self):
        self[self.currentList].pageDown()
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        # self.load_poster()

    def downmasterpage(self):
        self.timer = eTimer()
        self.timer.start(100, 1)
        try:
            self.timer_conn = self.timer.timeout.connect(self.load)
        except:
            self.timer.callback.append(self.load)

    def load(self):
        url = str(m3uest)
        self.index = 'group'
        self.cat_list = []
        content = getUrl(url)
        print("content 3 =", content)
        
        if '#EXTINF' in content:
            regexcat = '#EXTINF.*?,(.*?)\\n(.*?)\\n'
            match = re.compile(regexcat,re.DOTALL).findall(content)
            for name, url in match:
                # img = ('')
                url = url.replace(" ", "%20")
                url = url.replace("\\n", "")
                url = url.replace('\r','')
                url = url.replace('https','http')
                name = name.replace('\r','')
                self.cat_list.append(show_(name, url))
            self['menulist'].l.setList(self.cat_list)
            self['menulist'].l.setItemHeight(40)
            self['menulist'].moveToIndex(0)
            auswahl = self['menulist'].getCurrent()[0][0]
            self['name'].setText(auswahl)
            self['text'].setText('')
        else:
            return        

    def cat(self,url):
        self.index = 'cat'
        self.cat_list = []
        url=url
        print('read url: ',  url)
        # content = checkStr(getUrl(url))
        req = Request(url, None, headers=headers)
        content = urlopen(req, timeout=30).read()
        print("content 3 =", content)

        if '#EXTINF' in content:
            print("#EXTINF in content =========")
            regexcat = 'EXTINF.*?,(.*?)\\n(.*?)\\n'
            match = re.compile(regexcat,re.DOTALL).findall(content)
            items = []
            self.names = []
            self.urls = []
            for name, url in match:
                url = url.replace(" ", "%20")
                url = url.replace("\\n", "")
                url = url.replace('\r','')
                name = name.replace('\r','')
                print('name:', name)
                print('url final:', url)
                item = name + "###" + url
                items.append(item)
            items.sort()
            for item in items:
                name = item.split("###")[0]
                url = item.split("###")[1]
                
                self.cat_list.append(show_(name, url))
            self['menulist'].l.setList(self.cat_list)
            self['menulist'].l.setItemHeight(40)
            self['menulist'].moveToIndex(0)
            auswahl = self['menulist'].getCurrent()[0][0]
            self['name'].setText(auswahl)
        else:
            self.index = 'group'
            return

    def ok(self):
        id = self['menulist'].getCurrent()[0][1]
        url = str(id)
        print('url: ', url)    
        if self.index == 'cat':
            self.play_that_shit(url)
        else:
            auswahl = self['menulist'].getCurrent()[0][0]
            self['text'].setText(auswahl)
            self.cat(url)


    def play_that_shit(self, data):
        desc = self['menulist'].l.getCurrentSelection()[0][0]
        url = data
        name = desc
        self.session.open(Playstream2, name, url)

    def exit(self):
        if self.index == 'group':
            ReloadBouquet()
            self.close()
        elif self.index == 'cat':
            self.load()

    def message2(self):
        if self.index == 'group':
            name = self['menulist'].l.getCurrentSelection()[0][0]
            self.session.openWithCallback(self.convert,MessageBox,_("Do you want to Convert %s to favorite .tv ?")% name, MessageBox.TYPE_YESNO, timeout = 15, default = True)
        else:
            return

    def convert(self, result):
        url = self['menulist'].getCurrent()[0][1]
        url = str(url)
        print('url convert: ', url)
        name = self['menulist'].l.getCurrentSelection()[0][0]
        if result:
            self.convert_bouquet(url, name)
            # return
        else:
            return

    def convert_bouquet(self, url, name):
        xxxname = '/tmp/temporary.m3u'
        if os.path.exists(xxxname):
            print('permantly remove file ', file)
            os.remove(xxxname)
        try:
            url = str(url)
            name = str(name)
            print('name content: ', name)

            req = Request(url)
            req.add_header('User-Agent', 'Mozilla/5.0 (Windows NT 6.1; rv:52.0) Gecko/20100101 Firefox/52.0')
            content = checkStr(urlopen(req))
            content = content.read()
            print("content =", content)

            with open(xxxname, 'w') as f:
                f.write(content)
            bqtname = 'userbouquet.%s.tv' % name
            bouquetTvString = '#SERVICE 1:7:1:0:0:0:0:0:0:0:FROM BOUQUET "' + bqtname + '" ORDER BY bouquet\n'
            bouquet = 'bouquets.tv'
            self.iConsole = iConsole()
            desk_tmp = hls_opt = ''
            if os.path.isfile('/etc/enigma2/%s' % bqtname):
                        os.remove('/etc/enigma2/%s' % bqtname)
            with open('/etc/enigma2/%s' % bqtname, 'w') as outfile:
                        outfile.write('#NAME %s\r\n' % name.capitalize())
                        for line in open(xxxname):
                                if line.startswith('http://') or line.startswith('https'):
                                        outfile.write('#SERVICE 4097:0:1:1:0:0:0:0:0:0:%s' % line.replace(':', '%3a'))
                                        outfile.write('#DESCRIPTION %s' % desk_tmp)
                                elif line.startswith('#EXTINF'):
                                        desk_tmp = '%s' % line.split(',')[-1]
                                elif '<stream_url><![CDATA' in line:
                                        outfile.write('#SERVICE 4097:0:1:1:0:0:0:0:0:0:%s\r\n' % line.split('[')[-1].split(']')[0].replace(':', '%3a'))
                                        outfile.write('#DESCRIPTION %s\r\n' % desk_tmp)
                                elif '<title>' in line:
                                        if '<![CDATA[' in line:
                                                desk_tmp = '%s\r\n' % line.split('[')[-1].split(']')[0]
                                        else:
                                                desk_tmp = '%s\r\n' % line.split('<')[1].split('>')[1]
                        outfile.close()
            if os.path.isfile('/etc/enigma2/%s' % bqtname) and os.path.isfile('/etc/enigma2/bouquets.tv'):
                remove_line('/etc/enigma2/bouquets.tv', bqtname)
                with open('/etc/enigma2/bouquets.tv', 'a') as outfile:
                    outfile.write('#SERVICE 1:7:1:0:0:0:0:0:0:0:FROM BOUQUET "%s" ORDER BY bouquet\r\n' % bqtname)
                    outfile.close()
            self.mbox = self.session.open(openMessageBox, _('Shuffle Favorite List in Progress') + '\n' + _('Wait please ...'), openMessageBox.TYPE_INFO, timeout=5)
            ReloadBouquet()
        except:
            return


class Playstream2(Screen, InfoBarMenu, InfoBarBase, InfoBarSeek, InfoBarNotifications, InfoBarShowHide):

    def __init__(self, session, name, url):
        Screen.__init__(self, session)
        self.skinName = 'MoviePlayer'
        title = 'Play'
        self['list'] = MenuList([])
        InfoBarMenu.__init__(self)
        InfoBarNotifications.__init__(self)
        InfoBarBase.__init__(self)
        InfoBarShowHide.__init__(self)
        self['actions'] = ActionMap(['WizardActions',
         'MoviePlayerActions',
         'EPGSelectActions',
         'MediaPlayerSeekActions',
         'ColorActions',
         'InfobarShowHideActions',
         'InfobarActions'], {'leavePlayer': self.cancel,
         'back': self.cancel}, -1)
        self.allowPiP = False
        InfoBarSeek.__init__(self, actionmap='MediaPlayerSeekActions')
        url = url.replace(':', '%3a')
        self.url = url
        self.name = name
        self.srefOld = self.session.nav.getCurrentlyPlayingServiceReference()
        self.onLayoutFinish.append(self.openTest)

    def openTest(self):
        url = self.url
        pass
        ref = '4097:0:1:0:0:0:0:0:0:0:' + url
        sref = eServiceReference(ref)
        sref.setName(self.name)
        self.session.nav.stopService()
        self.session.nav.playService(sref)

    def cancel(self):
        if os.path.exists('/tmp/hls.avi'):
            os.remove('/tmp/hls.avi')
        self.session.nav.stopService()
        self.session.nav.playService(self.srefOld)
        self.close()

    def keyLeft(self):
        self['text'].left()

    def keyRight(self):
        self['text'].right()

    def keyNumberGlobal(self, number):
        self['text'].number(number)

def main(session, **kwargs):
    session.open(freearhey)


def Plugins(path, **kwargs):
    global plugin_path
    plugin_path = path
    return [PluginDescriptor(name='freearhey', description='freearhey plugin', where=[PluginDescriptor.WHERE_EXTENSIONSMENU], fnc=main), PluginDescriptor(name='freearhey', description='freearhey plugin', where=[PluginDescriptor.WHERE_PLUGINMENU], fnc=main, icon='plugin.png')]
