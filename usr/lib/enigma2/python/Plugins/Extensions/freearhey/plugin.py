# import zlib, base64
# exec zlib.decompress(base64.b64decode('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'))

import base64
from Components.Label import Label
from Components.Sources.StaticText import StaticText
from Components.MenuList import MenuList
from Components.Pixmap import Pixmap, MovingPixmap
from Components.MultiContent import MultiContentEntryText #, MultiContentEntryPixmap, MultiContentEntryPixmapAlphaTest
from Components.ServiceEventTracker import ServiceEventTracker, InfoBarBase
from enigma import eTimer, gFont, eTimer, eConsoleAppContainer, ePicLoad, loadPNG, getDesktop, eServiceReference, iPlayableService, eListboxPythonMultiContent, RT_HALIGN_LEFT, RT_HALIGN_RIGHT, RT_HALIGN_CENTER, RT_VALIGN_CENTER, eListbox
from Plugins.Plugin import PluginDescriptor
from Screens.Screen import Screen
from Screens.MessageBox import MessageBox
from Screens.InfoBarGenerics import *
from Screens.InfoBar import MoviePlayer, InfoBar
from twisted.web.client import downloadPage, getPage, error
from Tools.Directories import fileExists, resolveFilename, SCOPE_PLUGINS, pathExists
from Tools.LoadPixmap import LoadPixmap
import os, time, socket
import sha
import hashlib
import ssl
import re
from time import strptime, mktime
from Components.ActionMap import *
import sys
from Components.Console import Console as iConsole

try:
        from enigma import eDVBDB
except ImportError:
        eDVBDB = None


BRAND = '/usr/lib/enigma2/python/boxbranding.so'
BRANDP = '/usr/lib/enigma2/python/Plugins/PLi/__init__.pyo'
BRANDPLI ='/usr/lib/enigma2/python/Tools/StbHardware.pyo'
estm3u = 'aHR0cDovL3RpdnVzdHJlYW0uY29tL2ZoLnBocA=='
m3uest = base64.b64decode(estm3u)

PY3 = sys.version_info.major >= 3

if PY3:
    from urllib.request import  Request, urlopen
    from urllib.error import URLError, HTTPError
    from urllib.parse import urlparse
    from urllib.parse import quote, unquote_plus, unquote, urlencode
    import http.cookiejar
    from http.client import HTTPConnection, CannotSendRequest, BadStatusLine, HTTPException
    from urllib.request import urlretrieve

else:
    import cookielib
    from urllib2 import Request, urlopen
    from urllib2 import URLError, HTTPError
    from urlparse import urlparse
    from urllib import quote, unquote_plus, unquote, urlencode
    from httplib import HTTPConnection, CannotSendRequest, BadStatusLine, HTTPException
    from urllib import urlretrieve


cj = {}
# sz_w = getDesktop(0).size().width()
sz_w = getDesktop(0).size()
# if sz_w == 1920:
if sz_w.width() > 1280:
    Height = 60
else:
    Height = 40
# if sz_w.width() > 1280:
def checkStr(txt):
    # convert variable to type str both in Python 2 and 3
    if PY3:
        # Python 3
        if type(txt) == type(bytes()):
            txt = txt.decode('utf-8')
    else:
        #Python 2
        if type(txt) == type(unicode()):
            txt = txt.encode('utf-8')
    return txt
PLUGIN_PATH = '/usr/lib/enigma2/python/Plugins/Extensions/freearhey'

global skin_path
skin_path= PLUGIN_PATH +'/skin'
if fileExists(BRAND)or fileExists(BRANDP):
    skin_path= skin_path + '/skin_pli/'
else:
    skin_path= skin_path + '/skin_cvs/'

from enigma import addFont
try:
    addFont('%s/nxt1.ttf' % PLUGIN_PATH, 'RegularIPTV', 100, 1)
except Exception as ex:
    print('addfont', ex)

def checkInternet():
        try:
                response = urlopen("http://google.com", None, 5)
                response.close()
        except HTTPError:
                return False
        except URLError:
                return False
        except socket.timeout:
                return False

def getUrl(url):
    try:
            req = Request(url)
            req.add_header('User-Agent', 'Mozilla/5.0 (Windows NT 6.1; rv:52.0) Gecko/20100101 Firefox/52.0')
            response = urlopen(req)
            link = response.read()
            response.close()
            print("link =", link)
            return link

    except:
        if PY3:
            e = urllib.error.URLError# as e:
        else:
            e = urllib2.URLError #, e:
        print('We failed to open "%s".' % url)
        if hasattr(e, 'code'):
            print('We failed with error code - %s.' % e.code)
        if hasattr(e, 'reason'):
            print('We failed to reach a server.')
            print('Reason: ', e.reason)

def ReloadBouquet():
    try:
        eDVBDB.getInstance().reloadServicelist()
        eDVBDB.getInstance().reloadBouquets()
    except:
        os.system('wget -qO - http://127.0.0.1/web/servicelistreload?mode=2 > /dev/null 2>&1 &')

def remove_line(filename, what):
    if os.path.isfile(filename):
        file_read = open(filename).readlines()
        file_write = open(filename, 'w')
        for line in file_read:
            if what not in line:
                file_write.write(line)
        file_write.close()

class m2list(MenuList):

    def __init__(self, list):
        MenuList.__init__(self, list, False, eListboxPythonMultiContent)
        self.l.setFont(0, gFont('Regular', 14))
        self.l.setFont(1, gFont('Regular', 16))
        self.l.setFont(2, gFont('Regular', 18))
        self.l.setFont(3, gFont('Regular', 20))
        self.l.setFont(4, gFont('Regular', 22))
        self.l.setFont(5, gFont('Regular', 24))
        self.l.setFont(6, gFont('Regular', 26))
        self.l.setFont(7, gFont('Regular', 28))
        self.l.setFont(8, gFont('Regular', 32))
        self.l.setFont(9, gFont('Regular', 38))

def show_(name, link):#, img, session, description):
    res = [(name,link)]
    # if sz_w == 1920:
    if sz_w.width() > 1280:
        res.append(MultiContentEntryText(pos=(0, 0), size=(800, 40), font=9, text=name, flags=RT_HALIGN_CENTER | RT_VALIGN_CENTER))
    else:
        res.append(MultiContentEntryText(pos=(0, 0), size=(800, 40), font=8, text=name, flags=RT_HALIGN_CENTER | RT_VALIGN_CENTER))
    return res



def cat_(letter, link):
    res = [(letter, link)]
    # if sz_w == 1920:
    if sz_w.width() > 1280:
        res.append(MultiContentEntryText(pos=(0, 0), size=(800, 40), font=9, text=letter, flags=RT_HALIGN_CENTER | RT_VALIGN_CENTER))
    else:
        res.append(MultiContentEntryText(pos=(0, 0), size=(800, 40), font=8, text=letter, flags=RT_HALIGN_CENTER | RT_VALIGN_CENTER))
    return res

class freearhey(Screen):

    def __init__(self, session):
        if sz_w.width() > 1280:
                path = skin_path + 'defaultListScreen_new.xml'
        else:
                path =  skin_path + 'defaultListScreen.xml'
        with open(path, 'r') as f:
            self.skin = f.read()
            f.close()
        self.session = session
        Screen.__init__(self, session)
        self['actions'] = ActionMap(['OkCancelActions',
         'ColorActions',
         'DirectionActions',
         'MovieSelectionActions'], {'up': self.up,
         'down': self.down,
         'left': self.left,
         'right': self.right,
         'ok': self.ok,
		 'green': self.message2,
         'cancel': self.exit,
         'red': self.exit}, -1)
        self['menulist'] = m2list([])
        self['red'] = Label(_('Exit'))
        self['green'] = Label(_('Export'))
        self['title'] = Label('free')
        self['name'] = Label('')
        self['text'] = Label('')
        # self['poster'] = Pixmap()
        self.picload = ePicLoad()
        self.picfile = ''
        self.currentList = 'menulist'
        self.menulist = []
        self.loading_ok = False
        self.count = 0
        self.loading = 0
        self.oldService = self.session.nav.getCurrentlyPlayingServiceReference()
        self.onLayoutFinish.append(self.downmasterpage)

    def up(self):
        self[self.currentList].up()
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        # self.load_poster()

    def down(self):
        self[self.currentList].down()
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        # self.load_poster()

    def left(self):
        self[self.currentList].pageUp()
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        # self.load_poster()

    def right(self):
        self[self.currentList].pageDown()
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        # self.load_poster()

    def downmasterpage(self):
        self.timer = eTimer()
        self.timer.start(100, 1)
        try:
            self.timer_conn = self.timer.timeout.connect(self.load)
        except:
            self.timer.callback.append(self.load)

    def load(self):
        # url = 'https://bit.ly/2ZRG8Fd'
        url = str(m3uest)
        self.index = 'group'
        self.cat_list = []
        content = getUrl(url)
        print("content 3 =", content)
        regexcat = 'EXTINF.*?,(.*?)\\n(.*?)\\n'
        match = re.compile(regexcat,re.DOTALL).findall(content)
        for name, url in match:
            # img = ('')
            url = url.replace(" ", "")
            url = url.replace("\\n", "")
            url = url.replace('\r','')
            url = url.replace('https','http')
            name = name.replace('\r','')
            self.cat_list.append(show_(name, url))
        self['menulist'].l.setList(self.cat_list)
        self['menulist'].l.setItemHeight(40)
        self['menulist'].moveToIndex(0)
        auswahl = self['menulist'].getCurrent()[0][0]
        self['name'].setText(auswahl)
        self['text'].setText('')

    def cat(self,url):
        self.index = 'cat'
        self.cat_list = []
        url=url
        print('read url: ',  url)
        content = getUrl(url)
        print("content 3 =", content)
        if '#EXTINF' in content:
            print("Extinf in content =========")
            regexcat = 'EXTINF.*?,(.*?)\\n(.*?)\\n'
            match = re.compile(regexcat,re.DOTALL).findall(content)
            items = []
            self.names = []
            self.urls = []
            for name, url in match:
                url = url.replace(" ", "")
                url = url.replace("\\n", "")
                url = url.replace('\r','')
                name = name.replace('\r','')
                print('name:', name)
                print('url final:', url)
                item = name + "###" + url
                items.append(item)
            items.sort()
            for item in items:
                name = item.split("###")[0]
                url = item.split("###")[1]
                # self.names.append(name)
                # self.urls.append(url)
            self.cat_list.append(show_(name, url))
            self['menulist'].l.setList(self.cat_list)
            self['menulist'].l.setItemHeight(40)
            self['menulist'].moveToIndex(0)
            auswahl = self['menulist'].getCurrent()[0][0]
            self['name'].setText(auswahl)
        else:
            self.index = 'group'
            return

    def ok(self):
        if self.index == 'cat':
            id = self['menulist'].getCurrent()[0][1]
            url = str(id)
            print('url: ', url)
            self.play_that_shit(url)

        elif self.index == 'group':
            url = self['menulist'].getCurrent()[0][1]
            print('url: ', url)


            auswahl = self['menulist'].getCurrent()[0][0]
            self['text'].setText(auswahl)
            self.cat(url)


    def play_that_shit(self, data):
        desc = self['menulist'].l.getCurrentSelection()[0][0]
        url = data
        name = desc
        self.session.open(Playstream2, name, url)

    def exit(self):
        if self.index == 'group':
            ReloadBouquet()
            self.close()
        elif self.index == 'cat':
            self.load()

    def message2(self):
        if self.index == 'group':
            name = self['menulist'].l.getCurrentSelection()[0][0]
            self.session.openWithCallback(self.convert,MessageBox,_("Do you want to Convert %s to favorite .tv ?")% name, MessageBox.TYPE_YESNO, timeout = 15, default = True)
        else:
            return

    def convert(self, result):
        url = self['menulist'].getCurrent()[0][1]
        url = str(url)
        print('url convert: ', url)
        name = self['menulist'].l.getCurrentSelection()[0][0]
        if result:
            self.convert_bouquet(url, name)
            # return
        else:
            return

    def convert_bouquet(self, url, name):
        xxxname = '/tmp/temporary.m3u'
        if os.path.exists(xxxname):
            print('permantly remove file ', file)
            os.remove(xxxname)
        try:
            url = str(url)
            name = str(name)
            print('name content: ', name)

            req = Request(url)
            req.add_header('User-Agent', 'Mozilla/5.0 (Windows NT 6.1; rv:52.0) Gecko/20100101 Firefox/52.0')
            content = checkStr(urlopen(req))
            content = content.read()
            print("content =", content)

            with open(xxxname, 'w') as f:
                f.write(content)
            bqtname = 'userbouquet.%s.tv' % name
            bouquetTvString = '#SERVICE 1:7:1:0:0:0:0:0:0:0:FROM BOUQUET "' + bqtname + '" ORDER BY bouquet\n'
            bouquet = 'bouquets.tv'
            self.iConsole = iConsole()
            desk_tmp = hls_opt = ''
            if os.path.isfile('/etc/enigma2/%s' % bqtname):
                        os.remove('/etc/enigma2/%s' % bqtname)
            with open('/etc/enigma2/%s' % bqtname, 'w') as outfile:
                        outfile.write('#NAME %s\r\n' % name.capitalize())
                        for line in open(xxxname):
                                if line.startswith('http://') or line.startswith('https'):
                                        outfile.write('#SERVICE 4097:0:1:1:0:0:0:0:0:0:%s' % line.replace(':', '%3a'))
                                        outfile.write('#DESCRIPTION %s' % desk_tmp)
                                elif line.startswith('#EXTINF'):
                                        desk_tmp = '%s' % line.split(',')[-1]
                                elif '<stream_url><![CDATA' in line:
                                        outfile.write('#SERVICE 4097:0:1:1:0:0:0:0:0:0:%s\r\n' % line.split('[')[-1].split(']')[0].replace(':', '%3a'))
                                        outfile.write('#DESCRIPTION %s\r\n' % desk_tmp)
                                elif '<title>' in line:
                                        if '<![CDATA[' in line:
                                                desk_tmp = '%s\r\n' % line.split('[')[-1].split(']')[0]
                                        else:
                                                desk_tmp = '%s\r\n' % line.split('<')[1].split('>')[1]
                        outfile.close()
            if os.path.isfile('/etc/enigma2/%s' % bqtname) and os.path.isfile('/etc/enigma2/bouquets.tv'):
                remove_line('/etc/enigma2/bouquets.tv', bqtname)
                with open('/etc/enigma2/bouquets.tv', 'a') as outfile:
                    outfile.write('#SERVICE 1:7:1:0:0:0:0:0:0:0:FROM BOUQUET "%s" ORDER BY bouquet\r\n' % bqtname)
                    outfile.close()
            self.mbox = self.session.open(openMessageBox, _('Shuffle Favorite List in Progress') + '\n' + _('Wait please ...'), openMessageBox.TYPE_INFO, timeout=5)
            ReloadBouquet()
        except:
            return


class Playstream2(Screen, InfoBarMenu, InfoBarBase, InfoBarSeek, InfoBarNotifications, InfoBarShowHide):

    def __init__(self, session, name, url):
        Screen.__init__(self, session)
        self.skinName = 'MoviePlayer'
        title = 'Play'
        self['list'] = MenuList([])
        InfoBarMenu.__init__(self)
        InfoBarNotifications.__init__(self)
        InfoBarBase.__init__(self)
        InfoBarShowHide.__init__(self)
        self['actions'] = ActionMap(['WizardActions',
         'MoviePlayerActions',
         'EPGSelectActions',
         'MediaPlayerSeekActions',
         'ColorActions',
         'InfobarShowHideActions',
         'InfobarActions'], {'leavePlayer': self.cancel,
         'back': self.cancel}, -1)
        self.allowPiP = False
        InfoBarSeek.__init__(self, actionmap='MediaPlayerSeekActions')
        url = url.replace(':', '%3a')
        self.url = url
        self.name = name
        self.srefOld = self.session.nav.getCurrentlyPlayingServiceReference()
        self.onLayoutFinish.append(self.openTest)

    def openTest(self):
        url = self.url
        pass
        ref = '4097:0:1:0:0:0:0:0:0:0:' + url
        sref = eServiceReference(ref)
        sref.setName(self.name)
        self.session.nav.stopService()
        self.session.nav.playService(sref)

    def cancel(self):
        if os.path.exists('/tmp/hls.avi'):
            os.remove('/tmp/hls.avi')
        self.session.nav.stopService()
        self.session.nav.playService(self.srefOld)
        self.close()

    def keyLeft(self):
        self['text'].left()

    def keyRight(self):
        self['text'].right()

    def keyNumberGlobal(self, number):
        self['text'].number(number)

def main(session, **kwargs):
    session.open(freearhey)


def Plugins(path, **kwargs):
    global plugin_path
    plugin_path = path
    return [PluginDescriptor(name='freearhey', description='freearhey plugin', where=[PluginDescriptor.WHERE_EXTENSIONSMENU], fnc=main), PluginDescriptor(name='freearhey', description='freearhey plugin', where=[PluginDescriptor.WHERE_PLUGINMENU], fnc=main, icon='plugin.png')]
